#pragma once
#include "ci_3dtiles_tile.h"

#include "../include/g3dtile.h"

namespace _3DTiles
{
	//================================================================================
	/// 3D Tiles缓存瓦片实现类
	/// 继承自MapGIS::Tile::G3DTile，实现3D Tiles格式瓦片的缓存操作
	//================================================================================
	class Ci_G3D3DTilesCacheTileImpl : public MapGIS::Tile::G3DTile
	{
	public:
		//================================================================================
		/// 虚析构函数
		//================================================================================
		virtual ~Ci_G3D3DTilesCacheTileImpl();

		// 声明友元类
		friend class Ci_G3D3DTilesCacheTilesetImpl;
		friend class Ci_G3D3DTiles10CacheTilesetImpl;

	protected:
		//================================================================================
		/// 构造函数
		///
		/// @param [in] pCacheStorage 缓存存储器指针
		//================================================================================
		Ci_G3D3DTilesCacheTileImpl(MapGIS::Tile::G3DCacheStorage* pCacheStorage);

	public:
		//================================================================================
		/// 设置瓦片名称
		///
		/// @param [in] tileName 瓦片名称
		//================================================================================
		virtual void SetName(CGString tileName);

		//================================================================================
		/// 获取瓦片名称
		///
		/// @return 瓦片名称
		//================================================================================
		virtual CGString GetName();

		//================================================================================
		/// 设置包围体
		///
		/// @param [in] bounding 包围体对象
		//================================================================================
		virtual void SetBounding(MapGIS::Tile::BoundingVolume& bounding);

		//================================================================================
		/// 获取包围体
		///
		/// @return 包围体对象
		//================================================================================
		virtual MapGIS::Tile::BoundingVolume GetBounding();

		//================================================================================
		/// 设置几何误差
		///
		/// @param [in] geometricError 几何误差值
		//================================================================================
		virtual void SetGeometricError(float geometricError);

		//================================================================================
		/// 获取几何误差
		///
		/// @return 几何误差值
		//================================================================================
		virtual float GetGeometricError();

		//================================================================================
		/// 设置细化类型
		///
		/// @param [in] Refine 细化类型枚举值
		//================================================================================
		virtual void SetRefine(MapGIS::Tile::RefineType Refine);

		//================================================================================
		/// 获取细化类型
		///
		/// @return 细化类型枚举值
		//================================================================================
		virtual MapGIS::Tile::RefineType GetRefine();

		//================================================================================
		/// 设置变换矩阵
		///
		/// @param [in] mMatrix 4x4变换矩阵
		//================================================================================
		virtual void SetMatrix(MapGIS::Tile::Matrix4D mMatrix);

		//================================================================================
		/// 获取变换矩阵
		///
		/// @return 4x4变换矩阵
		//================================================================================
		virtual MapGIS::Tile::Matrix4D GetMatrix();

		//================================================================================
		/// 判断是否为根瓦片
		///
		/// @return 是否为根瓦片的判断结果
		//================================================================================
		virtual bool IsRoot();

		//================================================================================
		/// 获取相对路径
		///
		/// @return 相对路径字符串
		//================================================================================
		virtual CGString GetRelativePath() const;

		//================================================================================
		/// 关闭瓦片
		//================================================================================
		virtual void Close();

		//================================================================================
		/// 保存瓦片
		///
		/// @return 操作结果
		///         - gisLONG > 0：保存成功
		///         - gisLONG <= 0：保存失败
		//================================================================================
		virtual gisLONG Save();

		//================================================================================
		/// 移除子瓦片
		///
		/// @param [in] pChildTile 子瓦片对象指针
		/// @return 操作结果
		///         - gisLONG > 0：移除成功
		///         - gisLONG <= 0：移除失败
		//================================================================================
		virtual gisLONG RemoveChild(MapGIS::Tile::G3DTile* pChildTile);

		//================================================================================
		/// 移除指定索引的子瓦片
		///
		/// @param [in] index 子瓦片索引
		/// @return 操作结果
		///         - gisLONG > 0：移除成功
		///         - gisLONG <= 0：移除失败
		//================================================================================
		virtual gisLONG RemoveChild(int index);

		//================================================================================
		/// 获取子瓦片数量
		///
		/// @return 子瓦片数量
		//================================================================================
		virtual gisLONG GetChildNum();

		//================================================================================
		/// 获取内容信息
		///
		/// @return 瓦片内容信息对象
		//================================================================================
		virtual MapGIS::Tile::TileContentInfo GetContentInfo();

		//================================================================================
		/// 释放子对象
		//================================================================================
		virtual void ReleaseChildObjects();

		//================================================================================
		/// 获取缓存存储器
		///
		/// @return 缓存存储器指针
		//================================================================================
		virtual MapGIS::Tile::G3DCacheStorage* GetCacheStorage();

		//================================================================================
		/// 添加子瓦片
		///
		/// @param [in] mode 瓦片添加模式
		/// @return 新创建的子瓦片对象指针
		//================================================================================
		virtual MapGIS::Tile::G3DTile* AppendChild(MapGIS::Tile::TileAppendMode mode = MapGIS::Tile::TileAppendMode::AutoMode);

		//================================================================================
		/// 获取指定索引的子瓦片
		///
		/// @param [in] index 子瓦片索引
		/// @return 子瓦片对象指针
		//================================================================================
		virtual MapGIS::Tile::G3DTile* GetChild(int index);

		//================================================================================
		/// 设置级别限制
		///
		/// @param [in] levelsLimit 级别限制值
		//================================================================================
		virtual void SetLevelsLimit(int levelsLimit);

		//================================================================================
		/// 获取瓦片信息
		///
		/// @return 瓦片信息对象指针（当前实现返回NULL）
		//================================================================================
		virtual MapGIS::Tile::G3DTileInfo* GetInfo() { return NULL; };

	protected:
		//================================================================================
		/// 内部获取瓦片对象
		///
		/// @return 3D Tiles瓦片对象指针
		//================================================================================
		virtual _3DTiles::Ci_Tile* i_GetTile() const;

		//================================================================================
		/// 内部初始化子瓦片信息
		///
		/// @param [in,out] pChild      子瓦片对象指针
		/// @param [in]     parentName  父瓦片名称
		/// @param [in]     isSubTree   是否为子树
		/// @param [in]     isSubfolder 是否为子文件夹
		//================================================================================
		virtual void i_InItChildInfo(Ci_G3D3DTilesCacheTileImpl* pChild, CGString parentName, bool isSubTree, bool isSubfolder);

		//================================================================================
		/// 内部保存实现
		///
		/// @return 操作结果
		///         - gisLONG > 0：保存成功
		///         - gisLONG <= 0：保存失败
		//================================================================================
		virtual gisLONG i_Save();

		//================================================================================
		/// 内部更新子瓦片信息
		///
		/// @return 操作结果
		///         - gisLONG > 0：更新成功
		///         - gisLONG <= 0：更新失败
		//================================================================================
		virtual gisLONG i_UpdateChildInfo();

		//================================================================================
		/// 内部验证瓦片有效性
		///
		/// @return 是否有效的判断结果
		//================================================================================
		virtual bool i_IsValid() const;

		//================================================================================
		/// 内部创建子瓦片实例（纯虚函数）
		///
		/// @return 新创建的子瓦片对象指针
		//================================================================================
		virtual Ci_G3D3DTilesCacheTileImpl* i_CreateChildInstance() = 0;

		//================================================================================
		/// 内部获取缓存类型（纯虚函数）
		///
		/// @return 缓存类型枚举值
		//================================================================================
		virtual MapGIS::Tile::G3DCacheType i_GetCacheType() = 0;

	protected:
		CGString m_jsonRelativePath;                            // JSON相对路径
		CGString m_relativePath;                                // 相对路径
		CGString m_tileName;                                    // 瓦片名称
		// 两个中只能存在一个,m_pTile新建的，后面需要同步到文件中
		_3DTiles::Ci_Tile* m_pTile;                             // 瓦片对象指针
		_3DTiles::Ci_Tileset* m_pTileset;                       // 瓦片集对象指针
		MapGIS::Tile::ContentType m_contentType;                // 内容类型

		map<int, Ci_G3D3DTilesCacheTileImpl*> m_childs;         // 子瓦片映射表
		// 当前瓦片在子树的级别
		int m_subtreeLevel;                                     // 子树级别
		// tileset级别限制，大于或等于该级别则创建新的子树
		int m_levelsLimit;                                      // 级别限制
		MapGIS::Tile::G3DCacheStorage* m_pCacheStorage;         // 缓存存储器指针
	};

	//================================================================================
	/// 3D Tiles 1.0缓存瓦片实现类
	/// 继承自Ci_G3D3DTilesCacheTileImpl，实现3D Tiles 1.0版本瓦片的读写操作
	//================================================================================
	class Ci_G3D3DTiles10CacheTileImpl : public Ci_G3D3DTilesCacheTileImpl
	{
	public:
		//================================================================================
		/// 虚析构函数
		//================================================================================
		virtual ~Ci_G3D3DTiles10CacheTileImpl();

	protected:
		//================================================================================
		/// 构造函数
		///
		/// @param [in] pCacheStorage 缓存存储器指针
		//================================================================================
		Ci_G3D3DTiles10CacheTileImpl(MapGIS::Tile::G3DCacheStorage* pCacheStorage);

	public:
		//================================================================================
		/// 写入内容数据
		///
		/// @param [in] contentName 内容名称
		/// @param [in] pContents   内容对象列表
		/// @param [in] param       写入参数基类引用
		/// @return 操作结果
		///         - gisLONG > 0：写入成功
		///         - gisLONG <= 0：写入失败
		//================================================================================
		virtual gisLONG WriteContent(CGString contentName, vector<MapGIS::Tile::ContentBase*>* pContents, MapGIS::Tile::WriteContentParamBase& param);

		//================================================================================
		/// 读取内容数据
		///
		/// @param [in] pContents 内容对象列表
		/// @return 操作结果
		///         - gisLONG > 0：读取成功
		///         - gisLONG <= 0：读取失败
		//================================================================================
		virtual gisLONG ReadContent(vector<MapGIS::Tile::ContentBase*>* pContents);

		//================================================================================
		/// 打开瓦片
		///
		/// @param [in] pCacheStorage 缓存存储器指针
		/// @param [in] relativePath  相对路径
		/// @return 瓦片对象指针
		//================================================================================
		static MapGIS::Tile::G3DTile* Open(MapGIS::Tile::G3DCacheStorage* pCacheStorage, CGString relativePath);

	private:
		//================================================================================
		/// 内部创建子瓦片实例
		///
		/// @return 新创建的子瓦片对象指针
		//================================================================================
		virtual Ci_G3D3DTilesCacheTileImpl* i_CreateChildInstance();

		//================================================================================
		/// 内部获取缓存类型
		///
		/// @return 缓存类型枚举值
		//================================================================================
		virtual MapGIS::Tile::G3DCacheType i_GetCacheType();

		//================================================================================
		/// 写入高斯3D模型内容
		///
		/// @param [in] contentName 内容名称
		/// @param [in] pContent    高斯内容对象指针
		/// @param [in] writeParam  写入参数引用
		/// @return 操作结果
		///         - gisLONG > 0：写入成功
		///         - gisLONG <= 0：写入失败
		//================================================================================
		virtual gisLONG WriteGaussian3DModel(CGString contentName, MapGIS::Tile::GaussianContent* pContent, MapGIS::Tile::WriteGaussianContentParam& writeParam);

		//================================================================================
		/// 写入批处理3D模型内容
		///
		/// @param [in] contentName 内容名称
		/// @param [in] pContent    几何内容对象指针
		/// @param [in] writeParam  写入参数引用
		/// @return 操作结果
		///         - gisLONG > 0：写入成功
		///         - gisLONG <= 0：写入失败
		//================================================================================
		virtual gisLONG WriteBatched3DModel(CGString contentName, MapGIS::Tile::GeometryContent* pContent, MapGIS::Tile::WriteGeometryContentParam& writeParam);

		//================================================================================
		/// 写入实例化3D模型内容
		///
		/// @param [in] contentName 内容名称
		/// @param [in] pContent    几何内容对象指针
		/// @param [in] writeParam  写入参数引用
		/// @return 操作结果
		///         - gisLONG > 0：写入成功
		///         - gisLONG <= 0：写入失败
		//================================================================================
		virtual gisLONG WriteInstanced3DModel(CGString contentName, MapGIS::Tile::GeometryContent* pContent, MapGIS::Tile::WriteGeometryContentParam& writeParam);

		//================================================================================
		/// 写入点云内容
		///
		/// @param [in] contentName 内容名称
		/// @param [in] pContent    几何内容对象指针
		/// @param [in] writeParam  写入参数引用
		/// @return 操作结果
		///         - gisLONG > 0：写入成功
		///         - gisLONG <= 0：写入失败
		//================================================================================
		virtual gisLONG WritePoints(CGString contentName, MapGIS::Tile::GeometryContent* pContent, MapGIS::Tile::WriteGeometryContentParam& writeParam);

		//================================================================================
		/// 写入组合内容
		///
		/// @param [in] contentName 内容名称
		/// @param [in] pContents   内容对象列表
		/// @param [in] writeParam  写入参数引用
		/// @return 操作结果
		///         - gisLONG > 0：写入成功
		///         - gisLONG <= 0：写入失败
		//================================================================================
		virtual gisLONG WriteComposite(CGString contentName, vector<MapGIS::Tile::ContentBase*>* pContents, MapGIS::Tile::WriteGeometryContentParam& writeParam);

		//================================================================================
		/// 读取高斯3D模型内容
		///
		/// @param [in] info      内容信息对象
		/// @param [in] pContent  高斯内容对象指针
		/// @return 操作结果
		///         - gisLONG > 0：读取成功
		///         - gisLONG <= 0：读取失败
		//================================================================================
		virtual gisLONG ReadGaussian3DModel(MapGIS::Tile::TileContentInfo info, MapGIS::Tile::GaussianContent* pContent);

		//================================================================================
		/// 读取批处理3D模型内容
		///
		/// @param [in] info      内容信息对象
		/// @param [in] pContent  几何内容对象指针
		/// @return 操作结果
		///         - gisLONG > 0：读取成功
		///         - gisLONG <= 0：读取失败
		//================================================================================
		virtual gisLONG ReadBatched3DModel(MapGIS::Tile::TileContentInfo info, MapGIS::Tile::GeometryContent* pContent);

		//================================================================================
		/// 读取实例化3D模型内容
		///
		/// @param [in] info      内容信息对象
		/// @param [in] pContent  几何内容对象指针
		/// @return 操作结果
		///         - gisLONG > 0：读取成功
		///         - gisLONG <= 0：读取失败
		//================================================================================
		virtual gisLONG ReadInstanced3DModel(MapGIS::Tile::TileContentInfo info, MapGIS::Tile::GeometryContent* pContent);

		//================================================================================
		/// 读取点云内容
		///
		/// @param [in] info      内容信息对象
		/// @param [in] pContent  几何内容对象指针
		/// @return 操作结果
		///         - gisLONG > 0：读取成功
		///         - gisLONG <= 0：读取失败
		//================================================================================
		virtual gisLONG ReadPoints(MapGIS::Tile::TileContentInfo info, MapGIS::Tile::GeometryContent* pContent);

		//================================================================================
		/// 读取组合内容
		///
		/// @param [in] info      内容信息对象
		/// @param [in] pContents 内容对象列表
		/// @return 操作结果
		///         - gisLONG > 0：读取成功
		///         - gisLONG <= 0：读取失败
		//================================================================================
		virtual gisLONG ReadComposite(MapGIS::Tile::TileContentInfo info, vector<MapGIS::Tile::ContentBase*>* pContents);
	};

	//================================================================================
	/// 3D Tiles缓存瓦片集实现类
	/// 继承自MapGIS::Tile::G3DTileset，实现3D Tiles格式瓦片集的缓存操作
	//================================================================================
	class Ci_G3D3DTilesCacheTilesetImpl : public MapGIS::Tile::G3DTileset
	{
	public:
		//================================================================================
		/// 默认构造函数
		//================================================================================
		Ci_G3D3DTilesCacheTilesetImpl();

		//================================================================================
		/// 虚析构函数
		//================================================================================
		virtual ~Ci_G3D3DTilesCacheTilesetImpl();

	public:
		//================================================================================
		/// 获取缓存存储器
		///
		/// @return 缓存存储器指针
		//================================================================================
		virtual MapGIS::Tile::G3DCacheStorage* GetCacheStorage() { return m_pCacheStorage; };

		//================================================================================
		/// 获取根瓦片
		///
		/// @return 根瓦片对象指针
		//================================================================================
		virtual MapGIS::Tile::G3DTile* GetRoot() { return m_pRootTile; };

		//================================================================================
		/// 设置GUID
		///
		/// @param [in] guid GUID对象
		//================================================================================
		virtual void SetGUID(GUID guid) {};

		//================================================================================
		/// 获取GUID
		///
		/// @return GUID对象
		//================================================================================
		virtual GUID GetGUID()
		{
			GUID rtn;
			rtn.Data1 = 0;
			rtn.Data2 = 0;
			rtn.Data3 = 0;
			memset(rtn.Data4, 0, sizeof(unsigned char) * 8);
			return rtn;
		};

		//================================================================================
		/// 设置位置坐标
		///
		/// @param [in] dot 三维坐标点
		//================================================================================
		virtual void SetPosition(D_3DOT dot) { m_dot = dot; };

		//================================================================================
		/// 获取位置坐标
		///
		/// @return 三维坐标点
		//================================================================================
		virtual D_3DOT GetPosition() { return m_dot; };

		//================================================================================
		/// 设置树类型
		///
		/// @param [in] treeType 树类型枚举值
		//================================================================================
		virtual void SetTreeType(MapGIS::Tile::TreeType treeType);

		//================================================================================
		/// 获取树类型
		///
		/// @return 树类型枚举值
		//================================================================================
		virtual MapGIS::Tile::TreeType GetTreeType() { return MapGIS::Tile::TreeType::QuadTree; };

		//================================================================================
		/// 创建瓦片集
		///
		/// @param [in] pCacheStorage 缓存存储器指针
		/// @param [in] tilesetName   瓦片集名称
		/// @return 操作结果
		///         - gisLONG > 0：创建成功
		///         - gisLONG <= 0：创建失败
		//================================================================================
		virtual gisLONG Create(MapGIS::Tile::G3DCacheStorage* pCacheStorage, CGString tilesetName);

		//================================================================================
		/// 打开瓦片集
		///
		/// @param [in] pCacheStorage 缓存存储器指针
		/// @param [in] tilesetName   瓦片集名称
		/// @return 操作结果
		///         - gisLONG > 0：打开成功
		///         - gisLONG <= 0：打开失败
		//================================================================================
		virtual gisLONG Open(MapGIS::Tile::G3DCacheStorage* pCacheStorage, CGString tilesetName);

		//================================================================================
		/// 保存瓦片集
		///
		/// @return 操作结果
		///         - gisLONG > 0：保存成功
		///         - gisLONG <= 0：保存失败
		//================================================================================
		virtual gisLONG Save();

		//================================================================================
		/// 关闭瓦片集
		///
		/// @return 操作结果
		///         - gisLONG > 0：关闭成功
		///         - gisLONG <= 0：关闭失败
		//================================================================================
		virtual gisLONG Close();

		//================================================================================
		/// 验证瓦片集有效性
		///
		/// @return 是否有效的判断结果
		//================================================================================
		virtual bool IsValid();

		//================================================================================
		/// 获取Ci_Tileset对象
		///
		/// @return Ci_Tileset对象指针
		//================================================================================
		_3DTiles::Ci_Tileset* GetCiTileset() { return &m_tileset; }

		//================================================================================
		/// 设置结构树信息
		///
		/// @param [in] rootNode 根节点对象引用
		/// @return 操作结果
		///         - gisLONG > 0：设置成功
		///         - gisLONG <= 0：设置失败
		//================================================================================
		virtual gisLONG SetStructureTreeInfo(MapGIS::Tile::StructureTreeNode& rootNode) { return 0; };

		//================================================================================
		/// 获取结构树信息
		///
		/// @param [in] rootNode 根节点对象引用
		/// @return 操作结果
		///         - gisLONG > 0：获取成功
		///         - gisLONG <= 0：获取失败
		//================================================================================
		virtual gisLONG GetStructureTreeInfo(MapGIS::Tile::StructureTreeNode& rootNode) { return 0; };

		//================================================================================
		/// 开始写入SQLite数据库
		///
		/// @return 操作结果
		///         - gisLONG > 0：开始成功
		///         - gisLONG <= 0：开始失败
		//================================================================================
		virtual gisLONG StartWriteSqlite() { return 0; };

		//================================================================================
		/// 设置SQLite数据库中的包围盒信息
		/// 将TID与对应包围盒信息的映射关系写入SQLite数据库中
		///
		/// @param [in] tid2Box TID到包围盒信息的映射表，其中：
		///                     - key (gisINT64): TID标识符
		///                     - value (vector<double>):笛卡尔坐标系下的包围盒信息，包含6个值表示(xmin, ymin, zmin, xmax, ymax, zmax)
		//================================================================================
		virtual void SetBoxInfoInSqlite(const map<gisINT64, vector<double> >& tid2Box) {};

		//================================================================================
		/// 结束写入SQLite数据库
		///
		/// @return 操作结果
		///         - gisLONG > 0：结束成功
		///         - gisLONG <= 0：结束失败
		//================================================================================
		virtual gisLONG EndWriteSqlite() { return 0; };

		//================================================================================
		/// 获取瓦片集信息
		///
		/// @return 瓦片集信息对象指针（当前实现返回NULL）
		//================================================================================
		virtual MapGIS::Tile::G3DTilesetInfo* GetInfo() { return NULL; };

	protected:
		//================================================================================
		/// 内部创建根瓦片（纯虚函数）
		///
		/// @param [in] pCacheStorage 缓存存储器指针
		/// @return 根瓦片对象指针
		//================================================================================
		virtual Ci_G3D3DTilesCacheTileImpl* i_CreateRootTile(MapGIS::Tile::G3DCacheStorage* pCacheStorage) = 0;

		//================================================================================
		/// 内部获取缓存类型（纯虚函数）
		///
		/// @return 缓存类型枚举值
		//================================================================================
		virtual MapGIS::Tile::G3DCacheType i_GetCacheType() = 0;

	protected:
		CGString m_tilesetName;                                 // 瓦片集名称
		Ci_G3D3DTilesCacheTileImpl* m_pRootTile;                // 根瓦片对象指针
		MapGIS::Tile::G3DCacheStorage* m_pCacheStorage;         // 缓存存储器指针
		D_3DOT m_dot;                                           // 位置坐标点
		_3DTiles::Ci_Tileset m_tileset;                         // 瓦片集对象
	};

	//================================================================================
	/// 3D Tiles 1.0缓存瓦片集实现类
	/// 继承自Ci_G3D3DTilesCacheTilesetImpl，实现3D Tiles 1.0版本瓦片集的操作
	//================================================================================
	class Ci_G3D3DTiles10CacheTilesetImpl : public Ci_G3D3DTilesCacheTilesetImpl
	{
	public:
		//================================================================================
		/// 默认构造函数
		//================================================================================
		Ci_G3D3DTiles10CacheTilesetImpl();

		//================================================================================
		/// 虚析构函数
		//================================================================================
		virtual ~Ci_G3D3DTiles10CacheTilesetImpl();

	public:
		//================================================================================
		/// 清除图层字段信息
		//================================================================================
		virtual void ClearLayerFieldsInfo();

		//================================================================================
		/// 设置图层字段信息
		///
		/// @param [in] pLayersInfo 图层信息基类对象指针
		/// @return 操作结果
		///         - gisLONG > 0：设置成功
		///         - gisLONG <= 0：设置失败
		//================================================================================
		virtual gisLONG SetLayerFieldsInfo(const MapGIS::Tile::LayersInfoBase* pLayersInfo);

		//================================================================================
		/// 获取图层字段信息
		///
		/// @param [in] pLayersInfo 图层信息基类对象指针
		/// @return 操作结果
		///         - gisLONG > 0：获取成功
		///         - gisLONG <= 0：获取失败
		//================================================================================
		virtual gisLONG GetLayerFieldsInfo(MapGIS::Tile::LayersInfoBase* pLayersInfo);

	private:
		//================================================================================
		/// 内部创建根瓦片
		///
		/// @param [in] pCacheStorage 缓存存储器指针
		/// @return 根瓦片对象指针
		//================================================================================
		virtual Ci_G3D3DTilesCacheTileImpl* i_CreateRootTile(MapGIS::Tile::G3DCacheStorage* pCacheStorage);

		//================================================================================
		/// 内部获取缓存类型
		///
		/// @return 缓存类型枚举值
		//================================================================================
		virtual MapGIS::Tile::G3DCacheType i_GetCacheType();
	};
}