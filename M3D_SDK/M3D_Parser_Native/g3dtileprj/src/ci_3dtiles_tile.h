#pragma once
#include <string>
#include <cstring>
#include <algorithm>
#include <vector>
#include <map>
#include "rapidjson/document.h"
#include "../include/g3dtiledefine.h"
#include "../include/g3dtilespatial.h"
#include "../include/g3dtilerecord.h"
using namespace std;

namespace _3DTiles
{
	//================================================================================
	/// Asset信息类
	/// 存储3D Tiles资产的基本信息，如版本号等
	//================================================================================
	class Ci_Asset
	{
	public:
		//================================================================================
		/// 默认构造函数
		//================================================================================
		Ci_Asset();

		//================================================================================
		/// 析构函数
		//================================================================================
		~Ci_Asset();

		//================================================================================
		/// 将Asset信息写入JSON对象
		///
		/// @param [out] tilesetObj   JSON对象
		/// @param [in]  allocator    JSON分配器
		//================================================================================
		void WriteTo(rapidjson::Value& tilesetObj, rapidjson::Document::AllocatorType& allocator) const;

		//================================================================================
		/// 从JSON对象读取Asset信息
		///
		/// @param [in] tilesetObj JSON对象
		//================================================================================
		void ReadFrom(rapidjson::Value& tilesetObj);

		string m_version;           // 3D Tiles版本号
		string m_tilesetVersion;    // 瓦片集版本号

		//================================================================================
		/// 赋值运算符重载
		///
		/// @param [in] asset 源Asset对象
		/// @return 当前对象引用
		//================================================================================
		Ci_Asset& operator=(const Ci_Asset& asset)
		{
			if (this != &asset)
			{
				this->m_version = asset.m_version;
				this->m_tilesetVersion = asset.m_tilesetVersion;
			}
			return *this;
		}
	};

	//================================================================================
	/// URI对象类型枚举
	/// 定义不同类型的URI对象
	//================================================================================
	enum UriObjectType
	{
		uriObjectType_Unknown = 0,      // 未知类型
		uriObjectType_Tileset,          // 瓦片集类型
		uriObjectType_FileModel,        // 文件模型类型
		uriObjectType_Base64Model       // Base64编码模型类型
	};

	//================================================================================
	/// 3D Tiles URI对象类
	/// 存储URI相关信息
	//================================================================================
	class Ci_3DTileUriObject
	{
	public:
		//================================================================================
		/// 默认构造函数
		//================================================================================
		Ci_3DTileUriObject()
		{
			m_uriType = uriObjectType_Unknown;
			m_uri = "";
		}

		UriObjectType m_uriType;    // URI类型
		string m_uri;               // URI字符串

		//================================================================================
		/// 赋值运算符重载
		///
		/// @param [in] uri 源URI对象
		/// @return 当前对象引用
		//================================================================================
		Ci_3DTileUriObject& operator=(const Ci_3DTileUriObject& uri)
		{
			if (this != &uri)
			{
				this->m_uriType = uri.m_uriType;
				this->m_uri = uri.m_uri;
			}
			return *this;
		}
	};

	//================================================================================
	/// 3D Tiles内容类
	/// 存储瓦片内容信息
	//================================================================================
	class Ci_3DTileContent
	{
	public:
		//================================================================================
		/// 默认构造函数
		//================================================================================
		Ci_3DTileContent();

		//================================================================================
		/// 析构函数
		//================================================================================
		~Ci_3DTileContent();

		Ci_3DTileUriObject m_innerData;    // 内部数据URI对象

		//================================================================================
		/// 将内容信息写入JSON对象
		///
		/// @param [out] tilesetObj   JSON对象
		/// @param [in]  allocator    JSON分配器
		//================================================================================
		void WriteTo(rapidjson::Value& tilesetObj, rapidjson::Document::AllocatorType& allocator) const;

		//================================================================================
		/// 从JSON对象读取内容信息
		///
		/// @param [in] tilesetObj JSON对象
		//================================================================================
		void ReadFrom(rapidjson::Value& tilesetObj);

		//================================================================================
		/// 赋值运算符重载
		///
		/// @param [in] content 源内容对象
		/// @return 当前对象引用
		//================================================================================
		Ci_3DTileContent& operator=(const Ci_3DTileContent& content)
		{
			if (this != &content)
			{
				this->m_innerData = content.m_innerData;
			}
			return *this;
		}
	};

	//================================================================================
	/// 3D Tiles瓦片类
	/// 存储单个瓦片的所有信息
	//================================================================================
	class Ci_Tile
	{
	public:
		//================================================================================
		/// 默认构造函数
		//================================================================================
		Ci_Tile();

		//================================================================================
		/// 析构函数
		//================================================================================
		~Ci_Tile();

		MapGIS::Tile::RefineType m_refine;              // LOD细化类型
		float m_geometricError;                         // 几何误差
		MapGIS::Tile::BoundingVolume m_boundVolume;     // 包围体
		MapGIS::Tile::Matrix4D m_matrix;               // 变换矩阵
		vector<Ci_Tile> m_childs;                       // 子瓦片列表
		Ci_3DTileContent m_content;                     // 瓦片内容

		//================================================================================
		/// 将瓦片信息写入JSON对象
		///
		/// @param [out] tile      JSON对象
		/// @param [in]  allocator JSON分配器
		//================================================================================
		void WriteTo(rapidjson::Value& tile, rapidjson::Document::AllocatorType& allocator) const;

		//================================================================================
		/// 从JSON对象读取瓦片信息
		///
		/// @param [in] tile JSON对象
		//================================================================================
		void ReadFrom(rapidjson::Value& tile);

		//================================================================================
		/// 赋值运算符重载
		///
		/// @param [in] tile 源瓦片对象
		/// @return 当前对象引用
		//================================================================================
		Ci_Tile& operator=(const Ci_Tile& tile)
		{
			if (this != &tile)
			{
				this->m_refine = tile.m_refine;
				this->m_geometricError = tile.m_geometricError;
				this->m_boundVolume = tile.m_boundVolume;
				this->m_matrix = tile.m_matrix;
				this->m_childs.clear();
				for (auto child : tile.m_childs)
					this->m_childs.emplace_back(child);
				this->m_content = tile.m_content;
			}
			return *this;
		}
	};

	//================================================================================
	/// 3D Tiles瓦片集类
	/// 存储整个瓦片集的信息
	//================================================================================
	class Ci_Tileset
	{
	public:
		//================================================================================
		/// 构造函数
		///
		/// @param [in] file 文件路径
		//================================================================================
		Ci_Tileset(string file);

		//================================================================================
		/// 默认构造函数
		//================================================================================
		Ci_Tileset();

		//================================================================================
		/// 析构函数
		//================================================================================
		~Ci_Tileset();

		//================================================================================
		/// 将瓦片集信息写入JSON对象
		///
		/// @param [out] tileset    JSON对象
		/// @param [in]  allocator  JSON分配器
		//================================================================================
		void WriteTo(rapidjson::Value& tileset, rapidjson::Document::AllocatorType& allocator) const;

		//================================================================================
		/// 从JSON对象读取瓦片集信息
		///
		/// @param [in] tileset JSON对象
		//================================================================================
		void ReadFrom(rapidjson::Value& tileset);

		Ci_Asset m_asset;                               // 资产信息
		float m_geometricError;                         // 几何误差
		Ci_Tile m_root;                                 // 根瓦片

		// 属性字段
		vector<MapGIS::Tile::Field> m_fieldInfo;

		//================================================================================
		/// 赋值运算符重载
		///
		/// @param [in] tile 源瓦片集对象
		/// @return 当前对象引用
		//================================================================================
		Ci_Tileset& operator=(const Ci_Tileset& tile)
		{
			if (this != &tile)
			{
				this->m_asset = tile.m_asset;
				this->m_geometricError = tile.m_geometricError;
				this->m_root = tile.m_root;

				this->m_fieldInfo.clear();
				for (auto field : tile.m_fieldInfo)
					this->m_fieldInfo.emplace_back(field);
			}
			return *this;
		}
	};
}