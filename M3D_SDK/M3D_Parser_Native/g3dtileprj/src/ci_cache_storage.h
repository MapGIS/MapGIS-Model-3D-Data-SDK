#pragma once
#include "cgstring.h"
#include "../include/g3dtilestorage.h"

#ifdef _USE_MAPGIS_SDK_
#include "modelcache.h"
#include "mperror.h"
#endif // _USE_MAPGIS_SDK_

//================================================================================
/// 根据原始路径和相对路径生成完整路径
///
/// @param [in] orPath       原始路径
/// @param [in] relativePath 相对路径
/// @return 完整路径字符串
//================================================================================
CGString MakePathByRelativePath(CGString orPath, CGString relativePath);

namespace MapGIS
{
	namespace Tile
	{
		//================================================================================
		/// 本地缓存存储类
		/// 继承自G3DCacheStorage，实现本地文件系统的缓存存储操作
		//================================================================================
		class Ci_G3DLocalCacheStorage : public G3DCacheStorage
		{
		public:
			//================================================================================
			/// 构造函数
			///
			/// @param [in] url URL路径
			//================================================================================
			Ci_G3DLocalCacheStorage(CGString url);

			//================================================================================
			/// 构造函数
			///
			/// @param [in] url         URL路径
			/// @param [in] rootRelative 根相对路径
			//================================================================================
			Ci_G3DLocalCacheStorage(CGString url, CGString rootRelative);

			//================================================================================
			/// 虚析构函数
			//================================================================================
			virtual ~Ci_G3DLocalCacheStorage();

			//================================================================================
			/// 打开存储
			///
			/// @param [in] isCreateIfNotExist 不存在是否创建
			/// @return 操作结果
			///         - gisLONG > 0：打开成功
			///         - gisLONG <= 0：打开失败
			//================================================================================
			virtual gisLONG Open(bool isCreateIfNotExist = false);

			//================================================================================
			/// 判断存储是否有效
			///
			/// @return 是否有效的判断结果
			//================================================================================
			virtual bool IsValid();

			//================================================================================
			/// 关闭存储
			///
			/// @return 操作结果
			///         - gisLONG > 0：关闭成功
			///         - gisLONG <= 0：关闭失败
			//================================================================================
			virtual gisLONG Close();

			//================================================================================
			/// 获取数据内容
			///
			/// @param [in]  relative 相对路径
			/// @param [out] buffer   数据内容
			/// @return 操作结果
			///         - gisLONG > 0：获取成功
			///         - gisLONG <= 0：获取失败
			//================================================================================
			virtual gisLONG GetContent(CGString relative, CGByteArray& buffer);

			//================================================================================
			/// 设置数据内容（字节数组版本）
			///
			/// @param [in] relative 相对路径
			/// @param [in] buffer   数据内容
			/// @return 操作结果
			///         - gisLONG > 0：设置成功
			///         - gisLONG <= 0：设置失败
			//================================================================================
			virtual gisLONG SetContent(CGString relative, const CGByteArray& buffer);

			//================================================================================
			/// 设置数据内容（字符指针版本）
			///
			/// @param [in] relative 相对路径
			/// @param [in] buffer   数据内容
			/// @param [in] len      数据长度
			/// @return 操作结果
			///         - gisLONG > 0：设置成功
			///         - gisLONG <= 0：设置失败
			//================================================================================
			virtual gisLONG SetContent(CGString relative, const char* buffer, gisLONG len);

			//================================================================================
			/// 判断数据是否存在
			///
			/// @param [in] relative 相对路径
			/// @return 是否存在的判断结果
			///         - false：不存在
			///         - true：存在
			//================================================================================
			virtual bool IsExistContent(CGString relative);

			//================================================================================
			/// 删除数据
			///
			/// @param [in] relative 相对路径
			/// @return 操作结果
			///         - gisLONG > 0：删除成功
			///         - gisLONG <= 0：删除失败
			//================================================================================
			virtual gisLONG DeleteContent(CGString relative);

			//================================================================================
			/// 获取存储类型
			///
			/// @return 存储类型枚举值
			//================================================================================
			virtual StorageType GetStorageType();
		};

#ifdef _USE_MAPGIS_SDK_
		//================================================================================
		/// 服务器数据库缓存存储类
		/// 继承自G3DCacheStorage，实现服务器数据库的缓存存储操作
		//================================================================================
		class Ci_G3DServerDBCacheStorage : public G3DCacheStorage
		{
		public:
			//================================================================================
			/// 构造函数
			///
			/// @param [in] url URL路径
			//================================================================================
			Ci_G3DServerDBCacheStorage(CGString url);

			//================================================================================
			/// 构造函数
			///
			/// @param [in] url         URL路径
			/// @param [in] rootRelative 根相对路径
			//================================================================================
			Ci_G3DServerDBCacheStorage(CGString url, CGString rootRelative);

			//================================================================================
			/// 虚析构函数
			//================================================================================
			virtual ~Ci_G3DServerDBCacheStorage();

			//================================================================================
			/// 判断存储是否有效
			///
			/// @return 是否有效的判断结果
			//================================================================================
			virtual bool IsValid();

			//================================================================================
			/// 关闭存储
			///
			/// @return 操作结果
			///         - gisLONG > 0：关闭成功
			///         - gisLONG <= 0：关闭失败
			//================================================================================
			virtual gisLONG Close();

			//================================================================================
			/// 获取数据内容
			///
			/// @param [in]  relative 相对路径
			/// @param [out] buffer   数据内容
			/// @return 操作结果
			///         - gisLONG > 0：获取成功
			///         - gisLONG <= 0：获取失败
			//================================================================================
			virtual gisLONG GetContent(CGString relative, CGByteArray& buffer);

			//================================================================================
			/// 设置元数据信息
			///
			/// @param [in] cacheType 缓存类型
			/// @return 操作结果
			///         - gisLONG > 0：设置成功
			///         - gisLONG <= 0：设置失败
			//================================================================================
			virtual gisLONG SetMetaData(MapGIS::Tile::G3DCacheType cacheType);

			//================================================================================
			/// 判断数据是否存在
			///
			/// @param [in] relative 相对路径
			/// @return 是否存在的判断结果
			///         - false：不存在
			///         - true：存在
			//================================================================================
			virtual bool IsExistContent(CGString relative);

			//================================================================================
			/// 删除数据
			///
			/// @param [in] relative 相对路径
			/// @return 操作结果
			///         - gisLONG > 0：删除成功
			///         - gisLONG <= 0：删除失败
			//================================================================================
			virtual gisLONG DeleteContent(CGString relative);

			//================================================================================
			/// 获取存储类型
			///
			/// @return 存储类型枚举值
			//================================================================================
			virtual StorageType GetStorageType();

		protected:
			//================================================================================
			/// 内部释放模型缓存
			//================================================================================
			void i_FreeModelCache();

			CModelCache* m_pModelCache;    // 模型缓存指针
		};

		//================================================================================
		/// MongoDB缓存存储类
		/// 继承自Ci_G3DServerDBCacheStorage，实现MongoDB数据库的缓存存储操作
		//================================================================================
		class Ci_G3DMongoDBCacheStorage : public Ci_G3DServerDBCacheStorage
		{
		public:
			//================================================================================
			/// 构造函数
			///
			/// @param [in] url URL路径
			//================================================================================
			Ci_G3DMongoDBCacheStorage(CGString url);

			//================================================================================
			/// 构造函数
			///
			/// @param [in] url         URL路径
			/// @param [in] rootRelative 根相对路径
			//================================================================================
			Ci_G3DMongoDBCacheStorage(CGString url, CGString rootRelative);

			//================================================================================
			/// 虚析构函数
			//================================================================================
			virtual ~Ci_G3DMongoDBCacheStorage();

			//================================================================================
			/// 打开存储
			///
			/// @param [in] isCreateIfNotExist 不存在是否创建
			/// @return 操作结果
			///         - gisLONG > 0：打开成功
			///         - gisLONG <= 0：打开失败
			//================================================================================
			virtual gisLONG Open(bool isCreateIfNotExist = false);

			//================================================================================
			/// 设置数据内容（字节数组版本）
			///
			/// @param [in] relative 相对路径
			/// @param [in] buffer   数据内容
			/// @return 操作结果
			///         - gisLONG > 0：设置成功
			///         - gisLONG <= 0：设置失败
			//================================================================================
			virtual gisLONG SetContent(CGString relative, const CGByteArray& buffer);

			//================================================================================
			/// 设置数据内容（字符指针版本）
			///
			/// @param [in] relative 相对路径
			/// @param [in] buffer   数据内容
			/// @param [in] len      数据长度
			/// @return 操作结果
			///         - gisLONG > 0：设置成功
			///         - gisLONG <= 0：设置失败
			//================================================================================
			virtual gisLONG SetContent(CGString relative, const char* buffer, gisLONG len);
		};

		//================================================================================
		/// PostgreSQL缓存存储类
		/// 继承自Ci_G3DServerDBCacheStorage，实现PostgreSQL数据库的缓存存储操作
		//================================================================================
		class Ci_G3DPostgreSQLCacheStorage : public Ci_G3DServerDBCacheStorage
		{
		public:
			//================================================================================
			/// 构造函数
			///
			/// @param [in] url URL路径
			//================================================================================
			Ci_G3DPostgreSQLCacheStorage(CGString url);

			//================================================================================
			/// 构造函数
			///
			/// @param [in] url         URL路径
			/// @param [in] rootRelative 根相对路径
			//================================================================================
			Ci_G3DPostgreSQLCacheStorage(CGString url, CGString rootRelative);

			//================================================================================
			/// 虚析构函数
			//================================================================================
			virtual ~Ci_G3DPostgreSQLCacheStorage();

			//================================================================================
			/// 打开存储
			///
			/// @param [in] isCreateIfNotExist 不存在是否创建
			/// @return 操作结果
			///         - gisLONG > 0：打开成功
			///         - gisLONG <= 0：打开失败
			//================================================================================
			virtual gisLONG Open(bool isCreateIfNotExist = false);

			//================================================================================
			/// 设置数据内容（字节数组版本）
			///
			/// @param [in] relative 相对路径
			/// @param [in] buffer   数据内容
			/// @return 操作结果
			///         - gisLONG > 0：设置成功
			///         - gisLONG <= 0：设置失败
			//================================================================================
			virtual gisLONG SetContent(CGString relative, const CGByteArray& buffer);

			//================================================================================
			/// 设置数据内容（字符指针版本）
			///
			/// @param [in] relative 相对路径
			/// @param [in] buffer   数据内容
			/// @param [in] len      数据长度
			/// @return 操作结果
			///         - gisLONG > 0：设置成功
			///         - gisLONG <= 0：设置失败
			//================================================================================
			virtual gisLONG SetContent(CGString relative, const char* buffer, gisLONG len);
		};

#endif
	}
}