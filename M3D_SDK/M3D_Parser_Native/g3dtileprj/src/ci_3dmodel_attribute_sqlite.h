#pragma once
#include "sqlite3.h"
#include <map>
#include <string>
#include "bastypes.h"

#include "../include/g3dtilerecord.h"

using namespace std;

namespace MapGIS
{
	namespace Tile
	{
		//================================================================================
		/// 3D模型属性SQLite数据库操作类
		/// 提供对SQLite数据库中3D模型属性数据的读写操作
		//================================================================================
		class Ci_3DModelAttributeSqlite
		{
		public:
			//================================================================================
			/// 获取单例实例
			///
			/// @param [in] sqlitePath SQLite数据库路径
			/// @return 数据库操作对象指针
			//================================================================================
			static Ci_3DModelAttributeSqlite* GetInstance(string sqlitePath);

			//================================================================================
			/// 释放数据库操作对象
			///
			/// @param [in] pOwner 数据库操作对象指针
			//================================================================================
			static void Free3DModelAttributeSqlite(Ci_3DModelAttributeSqlite* pOwner);

			//================================================================================
			/// 从内存数据获取属性信息
			///
			/// @param [in]  data     内存数据指针
			/// @param [in]  length   数据长度
			/// @param [out] outAtt   输出属性信息
			/// @return 操作结果
			///         - gisLONG > 0：获取成功
			///         - gisLONG <= 0：获取失败
			//================================================================================
			static gisLONG GetAttributeByMemory(const char* data, int length, MapGIS::Tile::Attribute& outAtt);

		public:
			//================================================================================
			/// 打开数据库
			///
			/// @return 操作结果
			///         - gisLONG > 0：打开成功
			///         - gisLONG <= 0：打开失败
			//================================================================================
			gisLONG Open();

			//================================================================================
			/// 关闭数据库
			///
			/// @param [in] isSave 是否保存数据
			/// @return 操作结果
			///         - gisLONG > 0：关闭成功
			///         - gisLONG <= 0：关闭失败
			//================================================================================
			gisLONG Close(bool isSave = false);

			//================================================================================
			/// 创建数据库
			///
			/// @return 操作结果
			///         - gisLONG > 0：创建成功
			///         - gisLONG <= 0：创建失败
			//================================================================================
			gisLONG Create();

			//================================================================================
			/// 检查数据库是否存在
			///
			/// @return 操作结果
			///         - gisLONG > 0：存在
			///         - gisLONG <= 0：不存在
			//================================================================================
			gisLONG IsExist();

			//================================================================================
			/// 检查数据库是否已打开
			///
			/// @return 操作结果
			///         - gisLONG > 0：已打开
			///         - gisLONG <= 0：未打开
			//================================================================================
			gisLONG IsOpen();

			//================================================================================
			/// 保存数据到数据库
			///
			/// @return 操作结果
			///         - gisLONG > 0：保存成功
			///         - gisLONG <= 0：保存失败
			//================================================================================
			gisLONG Save();

			//================================================================================
			/// 获取属性数据
			///
			/// @return 属性数据指针
			//================================================================================
			MapGIS::Tile::Attribute* GetAttribute();

			//================================================================================
			/// 获取SQLite数据库路径
			///
			/// @return SQLite数据库路径
			//================================================================================
			string GetSqlitePath();

			//================================================================================
			/// 设置id与范围的关系
			/// 
			/// @param [in] tid2Box id与范围关系
			/// @return 属性数据指针
			//================================================================================
			void SetBoxInfo(const map<gisINT64, vector<double> >& tid2Box);

			//================================================================================
			/// 设置id与范围的关系
			///
			/// @return id与范围的关系
			//================================================================================
			const map<gisINT64, vector<double>>& GetBoxInfo() const;

		private:
			//================================================================================
			/// 构造函数
			///
			/// @param [in] sqlitePath SQLite数据库路径
			//================================================================================
			Ci_3DModelAttributeSqlite(string sqlitePath);

			//================================================================================
			/// 虚析构函数
			//================================================================================
			virtual ~Ci_3DModelAttributeSqlite();

			//================================================================================
			/// 内部添加文件信息
			///
			/// @return 操作结果
			///         - gisLONG > 0：添加成功
			///         - gisLONG <= 0：添加失败
			//================================================================================
			gisLONG i_AddFilesInfo();

			//================================================================================
			/// 内部添加TID图层信息
			///
			/// @return 操作结果
			///         - gisLONG > 0：添加成功
			///         - gisLONG <= 0：添加失败
			//================================================================================
			gisLONG i_AddTidByLayerInfo();

			//================================================================================
			/// 内部添加记录值
			///
			/// @return 操作结果
			///         - gisLONG > 0：添加成功
			///         - gisLONG <= 0：添加失败
			//================================================================================
			gisLONG i_AddRecordValue();

			//gisLONG i_ReadFilesInfo(vector< MapGIS::Tile::LayerFieldsInfo>& layerInfo);

			//gisLONG i_ReadRecordValue(MapGIS::Tile::LayerFieldsInfo& layerInfo, vector<MapGIS::Tile::Record>& records);

			//================================================================================
			/// 内部获取字段类型字符串
			///
			/// @param [in] type 字段类型枚举值
			/// @return 字段类型字符串
			//================================================================================
			CGString i_GetFieldType(MapGIS::Tile::FieldType type);

			//================================================================================
			/// 内部清除所有表
			///
			/// @return 操作结果
			///         - gisLONG > 0：清除成功
			///         - gisLONG <= 0：清除失败
			//================================================================================
			gisLONG i_ClearAllTable();

			//================================================================================
			/// 内部打开数据库
			///
			/// @return 操作结果
			///         - gisLONG > 0：打开成功
			///         - gisLONG <= 0：打开失败
			//================================================================================
			gisLONG i_OpenDb();

		private:
			static map<string, Ci_3DModelAttributeSqlite*>	m_mapSqlitePath;  // SQLite路径映射表
			sqlite3*										m_pDb;            // SQLite数据库指针
			string											m_sqlitePath;     // SQLite数据库路径
			MapGIS::Tile::Attribute							m_Attribute;      // 属性数据
			map<gisINT64, vector<double> >                  m_TID2Box;		  // id与范围关系
		};
	}
}