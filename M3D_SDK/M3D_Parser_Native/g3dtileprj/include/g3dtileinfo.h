#pragma once

#ifndef _G3D_TILE_INFO_H_
#define _G3D_TILE_INFO_H_

#include <map>
#include "g3dtilegeometry.h"
#include "g3dtiledefine.h"
#include "g3dtilespatial.h"
#include "gdelegatedefine.h"
#include "g3dtilerecord.h"

namespace M3D
{
	class Ci_ChildTileInfo;
	class Ci_Tile;
	class Ci_Content;
	class Ci_Tileset;
}

namespace MapGIS
{
	namespace Tile
	{

		//================================================================================
		/// 瓦片内容信息结构体
		/// 存储瓦片内容的相关路径和类型信息
		//================================================================================
		struct MAPGISG3DTILEEXPORT TileContentInfo
		{
			ContentType contentType;		// 瓦片内容类型（如glb、b3dm、i3dm等）
			CGString contentURI;			// 瓦片内容相对路径
			CGString tidURI;				// TID数据相对路径
			CGString geometryURI;			// 几何数据相对路径
			CGString attributeURI;			// 属性数据相对路径  
			GeometryType geometryType;		// 几何数据类型（点、线、面等）
			DataType dataType;				// 数据类型，仅对M3D数据有效

			//================================================================================
			/// 默认构造函数
			/// 初始化所有成员变量为默认值
			//================================================================================
			TileContentInfo()
			{
				contentType = ContentType::None;
				contentURI = "";
				geometryURI = "";
				attributeURI = "";
				tidURI = "";
				geometryType = GeometryType::None;
				dataType = DataType::None;
			}

			//================================================================================
			/// 虚析构函数
			//================================================================================
			virtual ~TileContentInfo() = default;

			//================================================================================
			/// 赋值运算符重载
			/// 实现深拷贝操作
			///
			/// @param [in] info 源瓦片内容信息对象
			/// @return 当前对象引用
			//================================================================================
			TileContentInfo& operator=(const TileContentInfo& info)
			{
				if (this != &info)
				{
					this->contentType = info.contentType;
					this->contentURI = info.contentURI;
					this->geometryURI = info.geometryURI;
					this->attributeURI = info.attributeURI;
					this->geometryType = info.geometryType;
					this->dataType = info.dataType;
					this->tidURI = info.tidURI;
				}
				return *this;
			}
		};

		//================================================================================
		/// 瓦片子节点信息基类
		/// 所有瓦片子节点信息类型的抽象基类
		//================================================================================
		class MAPGISG3DTILEEXPORT G3DTileChildInfo
		{
		public:
			//================================================================================
			/// 默认构造函数
			//================================================================================
			G3DTileChildInfo() = default;

			//================================================================================
			/// 虚析构函数
			/// 确保派生类能够正确析构
			//================================================================================
			virtual ~G3DTileChildInfo() = default;
		};

		//================================================================================
		/// 瓦片节点信息基类
		/// 定义瓦片节点信息的统一接口
		//================================================================================
		class MAPGISG3DTILEEXPORT G3DTileInfo
		{
		public:
			//================================================================================
			/// 默认构造函数
			//================================================================================
			G3DTileInfo() = default;

			//================================================================================
			/// 虚析构函数
			/// 确保派生类能够正确析构
			//================================================================================
			virtual ~G3DTileInfo() = default;

			//================================================================================
			/// 获取外包范围
			///
			/// @return 当前瓦片节点的外包范围信息
			//================================================================================
			virtual MapGIS::Tile::BoundingVolume GetBoundingVolume() const = 0;

			//================================================================================
			/// 获取转换矩阵
			///
			/// @return 当前瓦片节点的4x4转换矩阵
			//================================================================================
			virtual MapGIS::Tile::Matrix4D GetMatrix() const = 0;

			//================================================================================
			/// 获取瓦片内容信息
			///
			/// @return 当前瓦片节点的内容信息
			//================================================================================
			virtual MapGIS::Tile::TileContentInfo GetContentInfo() const = 0;

			//================================================================================
			/// 获取子节点个数
			///
			/// @return 当前瓦片节点的子节点数量
			//================================================================================
			virtual gisLONG GetChildNum() const = 0;

			//================================================================================
			/// 获取指定索引的子节点信息
			///
			/// @param [in] index 子节点索引（从0开始）
			/// @return 指定索引的子节点信息对象指针
			//================================================================================
			virtual MapGIS::Tile::G3DTileChildInfo* GetTileChildInfo(int index) = 0;
		};

		//================================================================================
		/// 瓦片集信息基类
		/// 定义瓦片集信息的统一接口
		//================================================================================
		class MAPGISG3DTILEEXPORT G3DTilesetInfo
		{
		public:
			//================================================================================
			/// 默认构造函数
			//================================================================================
			G3DTilesetInfo() = default;

			//================================================================================
			/// 虚析构函数
			/// 确保派生类能够正确析构
			//================================================================================
			virtual ~G3DTilesetInfo() = default;

			//================================================================================
			/// 获取根节点信息
			///
			/// @return 瓦片集根节点的信息对象指针
			//================================================================================
			virtual MapGIS::Tile::G3DTileChildInfo* GetRootInfo() const = 0;
		};

		//================================================================================
		/// M3D子瓦片信息类
		/// 提供对M3D格式子瓦片信息的只读访问接口
		//================================================================================
		class MAPGISG3DTILEEXPORT G3DM3DTileChildInfo : public G3DTileChildInfo
		{
		public:
			//================================================================================
			/// 构造函数
			///
			/// @param [in] info       底层M3D子瓦片信息对象指针
			/// @param [in] inFreeInfo 是否在析构时释放底层对象的标志
			//================================================================================
			G3DM3DTileChildInfo(M3D::Ci_ChildTileInfo* info, bool inFreeInfo);

			//================================================================================
			/// 析构函数
			//================================================================================
			virtual ~G3DM3DTileChildInfo();

			//================================================================================
			/// 获取外包范围
			///
			/// @return 当前子瓦片的外包范围信息
			//================================================================================
			virtual MapGIS::Tile::BoundingVolume GetBoundingVolume() const;

			//================================================================================
			/// 获取URL地址
			///
			/// @return 当前子瓦片的URL地址字符串
			//================================================================================
			virtual CGString GetURL() const;

			// 声明委托宏，用于访问底层M3D对象
			DECLARE_DELEGATE(M3D::Ci_ChildTileInfo*);
		};

		//================================================================================
		/// M3D瓦片信息类
		/// 提供对M3D格式瓦片信息的只读访问接口
		//================================================================================
		class MAPGISG3DTILEEXPORT G3DM3DTileInfo : public G3DTileInfo
		{
		public:
			//================================================================================
			/// 构造函数
			///
			/// @param [in] pTile      底层M3D瓦片对象指针
			/// @param [in] inFreeInfo 是否在析构时释放底层对象的标志
			//================================================================================
			G3DM3DTileInfo(M3D::Ci_Tile* pTile, bool inFreeInfo);

			//================================================================================
			/// 析构函数
			//================================================================================
			virtual ~G3DM3DTileInfo();

			//================================================================================
			/// 获取外包范围
			///
			/// @return 当前瓦片的外包范围信息
			//================================================================================
			virtual MapGIS::Tile::BoundingVolume GetBoundingVolume() const;

			//================================================================================
			/// 获取转换矩阵
			///
			/// @return 当前瓦片的4x4转换矩阵
			//================================================================================
			virtual MapGIS::Tile::Matrix4D GetMatrix() const;

			//================================================================================
			/// 获取瓦片内容信息
			///
			/// @return 当前瓦片的内容信息
			//================================================================================
			virtual MapGIS::Tile::TileContentInfo GetContentInfo() const;

			//================================================================================
			/// 获取子节点个数
			///
			/// @return 当前瓦片的子节点数量
			//================================================================================
			virtual gisLONG GetChildNum() const;

			//================================================================================
			/// 获取指定索引的子节点信息
			/// 注意：内部维护子节点信息对象，外部调用者无需手动销毁
			///
			/// @param [in] index 子节点索引（从0开始）
			/// @return 指定索引的子节点信息对象指针
			//================================================================================
			virtual MapGIS::Tile::G3DTileChildInfo* GetTileChildInfo(int index);

			//================================================================================
			/// 获取瓦片名称
			///
			/// @return 当前瓦片的名称字符串
			//================================================================================
			virtual CGString GetName() const;

			//================================================================================
			/// 获取瓦片级别
			///
			/// @return 当前瓦片的层级编号
			//================================================================================
			virtual gisLONG GetLevel() const;

			//================================================================================
			/// 获取LOD切换模式
			///
			/// @return 当前瓦片的LOD切换模式枚举值
			//================================================================================
			virtual MapGIS::Tile::LodMode GetLodMode() const;

			//================================================================================
			/// 获取LOD加载模式
			///
			/// @return 当前瓦片的LOD加载模式枚举值（ADD/REPLACE）
			//================================================================================
			virtual MapGIS::Tile::RefineType GetLodType() const;

			//================================================================================
			/// 获取LOD误差值
			///
			/// @return 当前瓦片的LOD误差阈值
			//================================================================================
			virtual float GetLodError() const;

			//================================================================================
			/// 获取父节点URL
			///
			/// @return 当前瓦片父节点的URL地址字符串
			//================================================================================
			virtual CGString GetParentNodeURI() const;

			//================================================================================
			/// 获取共享节点URL
			///
			/// @return 当前瓦片共享节点的URL地址字符串
			//================================================================================
			virtual CGString GetSharedURI() const;

			//================================================================================
			/// 获取瓦片数据个数
			/// 一个瓦片可以挂载多个数据内容，但只能同时显示其中一个
			///
			/// @return 当前瓦片挂载的数据内容个数
			//================================================================================
			virtual gisLONG GetContentNum() const;

			//================================================================================
			/// 获取当前显示的瓦片数据序号
			///
			/// @return 当前正在显示的数据内容索引
			//================================================================================
			virtual gisLONG GetUseContentIndex() const;

			//================================================================================
			/// 根据序号获取瓦片内容信息
			///
			/// @param [in] index 内容数据索引
			/// @return 指定索引的内容信息对象
			//================================================================================
			virtual MapGIS::Tile::TileContentInfo GetContentInfo(gisLONG index) const;

			//================================================================================
			/// 获取扩展信息个数
			///
			/// @return 扩展信息键值对的数量
			//================================================================================
			virtual gisLONG GetExtendNum() const;

			//================================================================================
			/// 获取扩展信息
			///
			/// @return 包含所有扩展信息的键值对映射表
			//================================================================================
			virtual map<CGString, CGString> GetExtend() const;

			// 声明委托宏，用于访问底层M3D对象
			DECLARE_DELEGATE(M3D::Ci_Tile*);

		private:
			// 子节点信息缓存映射表，用于避免重复创建对象
			map<int, MapGIS::Tile::G3DTileChildInfo*> m_childInfo;
		};
		//================================================================================
/// M3D瓦片集信息类
/// 提供对M3D格式瓦片集信息的只读访问接口
//================================================================================
		class MAPGISG3DTILEEXPORT G3DM3DTilesetInfo : public G3DTilesetInfo
		{
		public:
			//================================================================================
			/// 构造函数
			///
			/// @param [in] pTileset   底层M3D瓦片集对象指针
			/// @param [in] inFreeInfo 是否在析构时释放底层对象的标志
			//================================================================================
			G3DM3DTilesetInfo(M3D::Ci_Tileset* pTileset, bool inFreeInfo);

			//================================================================================
			/// 析构函数
			//================================================================================
			virtual ~G3DM3DTilesetInfo();

			//================================================================================
			/// 获取外包范围
			///
			/// @return 当前瓦片集的整体外包范围信息
			//================================================================================
			virtual MapGIS::Tile::BoundingVolume GetBoundingVolume() const;

			//================================================================================
			/// 获取根节点信息
			/// 注意：内部维护根节点信息对象，外部调用者无需手动销毁，但外包范围可能不准确
			///
			/// @return 瓦片集根节点的信息对象指针
			//================================================================================
			virtual MapGIS::Tile::G3DTileChildInfo* GetRootInfo() const;

			//================================================================================
			/// 获取说明信息
			///
			/// @return 瓦片集的说明描述字符串
			//================================================================================
			virtual CGString GetAsset() const;

			//================================================================================
			/// 获取M3D版本
			///
			/// @return 当前瓦片集的M3D格式版本枚举值
			//================================================================================
			virtual MapGIS::Tile::M3DVersion GetVersion() const;

			//================================================================================
			/// 获取名称
			///
			/// @return 瓦片集的名称字符串
			//================================================================================
			virtual CGString GetName() const;

			//================================================================================
			/// 获取GUID
			///
			/// @return 瓦片集的全局唯一标识符
			//================================================================================
			virtual GUID GetGUID() const;

			//================================================================================
			/// 获取文件压缩类型
			///
			/// @return 瓦片集文件的压缩格式类型枚举值
			//================================================================================
			virtual MapGIS::Tile::FileCompressType GetCompressType() const;

			//================================================================================
			/// 获取空间参照系信息
			///
			/// @return 瓦片集使用的空间坐标系枚举值
			//================================================================================
			virtual MapGIS::Tile::SpatialReference GetSpatialReference() const;

			//================================================================================
			/// 获取空间树类型
			///
			/// @return 瓦片集采用的空间索引树类型枚举值
			//================================================================================
			virtual MapGIS::Tile::TreeType GetTreeType() const;

			//================================================================================
			/// 获取瓦片加载模式
			///
			/// @return 瓦片集的LOD加载模式枚举值（ADD/REPLACE）
			//================================================================================
			virtual MapGIS::Tile::RefineType GetLodType() const;

			//================================================================================
			/// 获取原点坐标
			///
			/// @return 瓦片集坐标系原点的三维坐标值
			//================================================================================
			virtual D_3DOT GetPosition() const;

			//================================================================================
			/// 获取属性结构信息
			/// 仅对M3D 2.0版本有效
			///
			/// @return 包含所有属性字段定义的向量
			//================================================================================
			virtual vector<MapGIS::Tile::Field> GetFields() const;

			//================================================================================
			/// 获取根节点URL
			///
			/// @return 瓦片集根节点文件的URL地址字符串
			//================================================================================
			virtual CGString GetRootNodeURI() const;

			//================================================================================
			/// 获取图层信息URL
			/// 仅对M3D 2.1和2.2版本有效
			///
			/// @return 图层信息文件的URL地址字符串
			//================================================================================
			virtual CGString GetLayerInfoURI() const;

			//================================================================================
			/// 获取结构树URL
			/// 仅对M3D 2.1和2.2版本有效
			///
			/// @return 结构树文件的URL地址字符串
			//================================================================================
			virtual CGString GetStructureTree() const;

			//================================================================================
			/// 获取SQLite属性文件路径
			/// 当属性数据存储在SQLite数据库中时有效，仅对M3D 2.2版本有效
			///
			/// @return SQLite属性数据库文件的URL地址字符串
			//================================================================================
			virtual CGString GetSqlitePath() const;

			// 声明委托宏，用于访问底层M3D对象
			DECLARE_DELEGATE(M3D::Ci_Tileset*);

		private:
			// 根节点信息对象指针缓存
			MapGIS::Tile::G3DTileChildInfo* pRootChildInfo;
		};
	}
}
#endif