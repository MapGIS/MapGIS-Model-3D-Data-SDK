#pragma once
#ifndef _G3D_TILE_CONTENT_H_
#define _G3D_TILE_CONTENT_H_

#include "g3dtiledefine.h"
#include "g3dtilegeometry.h"
#include "g3dtilerecord.h"

namespace MapGIS
{
	namespace Tile
	{
		//================================================================================
		/// 模型实例信息结构体
		/// 用于描述模型实例化时的各种变换参数和标识信息
		//================================================================================
		struct MAPGISG3DTILEEXPORT ModelInstance
		{
			D_3DOT position;              // 实例在世界坐标系中的位置坐标
			D_3DOT normalUp;              // 实例的上方向向量（用于确定朝向）
			bool   hasNormalUp;           // 标识是否设置了上方向向量
			D_3DOT normalRight;           // 实例的右方向向量（用于确定朝向）
			bool   hasNormalRight;        // 标识是否设置了右方向向量
			float  scale;                 // 实例的均匀缩放因子
			bool   hasScale;              // 标识是否设置了均匀缩放
			D_3DOT scaleNonUniform;       // 实例的非均匀缩放因子（XYZ三个方向）
			bool   hasScaleNonUniform;    // 标识是否设置了非均匀缩放
			gisINT64 id;                  // 实例的唯一标识符
			bool   hasId;                 // 标识是否设置了实例ID

			//================================================================================
			/// 默认构造函数
			/// 初始化所有成员变量为默认值
			//================================================================================
			ModelInstance()
			{
				memset(&position, 0, sizeof(D_3DOT));
				memset(&normalUp, 0, sizeof(D_3DOT));
				memset(&normalRight, 0, sizeof(D_3DOT));
				memset(&scaleNonUniform, 0, sizeof(D_3DOT));
				scale = 1.0f;
				hasNormalUp = false;
				hasNormalRight = false;
				hasScale = false;
				hasScaleNonUniform = false;
				id = 0;
				hasId = false;
			}

			//================================================================================
			/// 赋值运算符重载
			/// 实现深拷贝操作
			///
			/// @param [in] instance 源实例对象
			/// @return 当前实例对象引用
			//================================================================================
			ModelInstance& operator=(const ModelInstance& instance)
			{
				if (this != &instance)
				{
					position = instance.position;
					normalUp = instance.normalUp;
					hasNormalUp = instance.hasNormalUp;
					normalRight = instance.normalRight;
					hasNormalRight = instance.hasNormalRight;
					scale = instance.scale;
					hasScale = instance.hasScale;
					scaleNonUniform = instance.scaleNonUniform;
					hasScaleNonUniform = instance.hasScaleNonUniform;
					id = instance.id;
					hasId = instance.hasId;
				}
				return *this;
			}
		};

		//================================================================================
		/// 瓦片内容基类
		/// 所有瓦片内容类型的抽象基类，提供统一的接口
		//================================================================================
		class MAPGISG3DTILEEXPORT ContentBase
		{
		public:
			//================================================================================
			/// 默认构造函数
			//================================================================================
			ContentBase() = default;

			//================================================================================
			/// 虚析构函数
			/// 确保派生类能够正确析构
			//================================================================================
			virtual ~ContentBase() = default;
		};

		//================================================================================
		/// 几何类型瓦片内容类（点/线/面）
		/// 用于存储和管理几何模型数据、属性数据和实例化信息
		//================================================================================
		class MAPGISG3DTILEEXPORT GeometryContent : public ContentBase
		{
		public:
			//================================================================================
			/// 默认构造函数
			//================================================================================
			GeometryContent();

			//================================================================================
			/// 移动构造函数
			/// 实现资源的高效转移
			///
			/// @param [in] item 源对象（右值引用）
			//================================================================================
			GeometryContent(GeometryContent&& item) noexcept;

			//================================================================================
			/// 析构函数
			/// 自动释放内部管理的资源
			//================================================================================
			~GeometryContent();

			//================================================================================
			/// 移动赋值运算符
			/// 实现资源的高效转移
			///
			/// @param [in] item 源对象（右值引用）
			/// @return 当前对象引用
			//================================================================================
			GeometryContent& operator=(GeometryContent&& item) noexcept;

			//================================================================================
			/// 创建数据对象
			/// 根据参数决定创建哪些数据对象并由内部管理其生命周期
			///
			/// @param [in] createModel     是否创建几何模型对象
			/// @param [in] type            几何模型类型（点/线/面等）
			/// @param [in] createAttribute 是否创建属性对象
			/// @param [in] createInstances 是否创建实例化信息对象
			//================================================================================
			void CreateData(bool createModel, GeometryType type, bool createAttribute, bool createInstances);

			//================================================================================
			/// 获取三维模型对象
			///
			/// @return 三维模型对象指针，如果未创建则返回nullptr
			//================================================================================
			G3DModel* Get3DModel();

			//================================================================================
			/// 设置三维模型对象（外部管理生命周期）
			///
			/// @param [in] pModel 三维模型对象指针
			/// @remark 对象的生命周期由调用者管理，内部不会自动释放
			//================================================================================
			void Set3DModel(G3DModel* pModel);

			//================================================================================
			/// 获取属性对象
			///
			/// @return 属性对象指针，如果未创建则返回nullptr
			//================================================================================
			Attribute* GetAttribute();

			//================================================================================
			/// 设置属性对象（外部管理生命周期）
			///
			/// @param [in] pAttribute 属性对象指针
			/// @remark 对象的生命周期由调用者管理，内部不会自动释放
			//================================================================================
			void SetAttribute(Attribute* pAttribute);

			//================================================================================
			/// 获取模型实例化信息
			///
			/// @return 实例化信息向量指针，如果未创建则返回nullptr
			//================================================================================
			vector<ModelInstance>* GetModelInstance();

			//================================================================================
			/// 设置模型实例化信息（外部管理生命周期）
			///
			/// @param [in] pInstances 实例化信息向量指针
			/// @remark 对象的生命周期由调用者管理，内部不会自动释放
			//================================================================================
			void SetModelInstance(vector<ModelInstance>* pInstances);

			//================================================================================
			/// 获取几何类型
			///
			/// @return 几何类型枚举值
			//================================================================================
			GeometryType GetGeometryType() const;

		private:
			//================================================================================
			/// 内部数据释放函数
			/// 释放由内部管理的资源
			//================================================================================
			void i_FreeData();

		private:
			G3DModel* m_pModel;          // 三维模型对象指针
			Attribute* m_pAttribute;      // 属性对象指针
			vector<ModelInstance>* m_pInstances;      // 实例化信息向量指针
			bool                   m_isFreeModel;     // 标识是否需要释放模型对象
			bool                   m_isFreeAttribute; // 标识是否需要释放属性对象
			bool                   m_isFreeInstances; // 标识是否需要释放实例化信息
		};

		//================================================================================
		/// 体元（栅格）瓦片内容类
		/// 用于存储和管理体元数据及其属性信息
		//================================================================================
		class MAPGISG3DTILEEXPORT VoxelContent : public ContentBase
		{
		public:
			//================================================================================
			/// 默认构造函数
			//================================================================================
			VoxelContent();

			//================================================================================
			/// 移动构造函数
			/// 实现资源的高效转移
			///
			/// @param [in] item 源对象（右值引用）
			//================================================================================
			VoxelContent(VoxelContent&& item) noexcept;

			//================================================================================
			/// 析构函数
			/// 自动释放内部管理的资源
			//================================================================================
			~VoxelContent();

			//================================================================================
			/// 移动赋值运算符
			/// 实现资源的高效转移
			///
			/// @param [in] item 源对象（右值引用）
			/// @return 当前对象引用
			//================================================================================
			VoxelContent& operator=(VoxelContent&& item) noexcept;

			//================================================================================
			/// 创建数据对象
			/// 根据参数决定创建哪些数据对象并由内部管理其生命周期
			///
			/// @param [in] createModel     是否创建体元模型对象
			/// @param [in] createAttribute 是否创建属性对象
			//================================================================================
			void CreateData(bool createModel, bool createAttribute);

			//================================================================================
			/// 获取三维体元模型对象
			///
			/// @return 体元模型对象指针，如果未创建则返回nullptr
			//================================================================================
			VoxelModel* Get3DModel();

			//================================================================================
			/// 设置三维体元模型对象（外部管理生命周期）
			///
			/// @param [in] pModel 体元模型对象指针
			/// @remark 对象的生命周期由调用者管理，内部不会自动释放
			//================================================================================
			void Set3DModel(VoxelModel* pModel);

			//================================================================================
			/// 获取属性对象向量
			///
			/// @return 属性对象向量指针，如果未创建则返回nullptr
			//================================================================================
			vector<Attribute>* GetAttribute();

			//================================================================================
			/// 设置属性对象向量（外部管理生命周期）
			///
			/// @param [in] pAttribute 属性对象向量指针
			/// @remark 对象的生命周期由调用者管理，内部不会自动释放
			//================================================================================
			void SetAttribute(vector<Attribute>* pAttribute);

		private:
			//================================================================================
			/// 内部数据释放函数
			/// 释放由内部管理的资源
			//================================================================================
			void i_FreeData();

			VoxelModel* m_pModel;          // 体元模型对象指针
			vector<Attribute>* m_pAttribute;     // 属性对象向量指针
			bool              m_isFreeModel;     // 标识是否需要释放体元模型对象
			bool              m_isFreeAttribute; // 标识是否需要释放属性对象
		};

		//================================================================================
		/// 高斯溅射瓦片内容类
		/// 用于存储和管理高斯溅射数据模型
		//================================================================================
		class MAPGISG3DTILEEXPORT GaussianContent : public ContentBase
		{
		public:
			//================================================================================
			/// 默认构造函数
			//================================================================================
			GaussianContent();

			//================================================================================
			/// 移动构造函数
			/// 实现资源的高效转移
			///
			/// @param [in] item 源对象（右值引用）
			//================================================================================
			GaussianContent(GaussianContent&& item) noexcept;

			//================================================================================
			/// 析构函数
			/// 自动释放内部管理的资源
			//================================================================================
			~GaussianContent();

			//================================================================================
			/// 移动赋值运算符
			/// 实现资源的高效转移
			///
			/// @param [in] item 源对象（右值引用）
			/// @return 当前对象引用
			//================================================================================
			GaussianContent& operator=(GaussianContent&& item) noexcept;

			//================================================================================
			/// 创建数据对象
			/// 根据参数决定是否创建高斯数据模型对象并由内部管理其生命周期
			///
			/// @param [in] createGeometry 是否创建高斯数据模型对象
			//================================================================================
			void CreateData(bool createGeometry);

			//================================================================================
			/// 获取高斯数据模型对象
			///
			/// @return 高斯数据模型对象指针，如果未创建则返回nullptr
			//================================================================================
			GaussianModel* Get3DModel();

			//================================================================================
			/// 设置高斯数据模型对象（外部管理生命周期）
			///
			/// @param [in] pModel 高斯数据模型对象指针
			/// @remark 对象的生命周期由调用者管理，内部不会自动释放
			//================================================================================
			void Set3DModel(GaussianModel* pModel);

		private:
			//================================================================================
			/// 内部数据释放函数
			/// 释放由内部管理的资源
			//================================================================================
			void i_FreeData();

			GaussianModel* m_pModel;      // 高斯数据模型对象指针
			bool           m_isFreeModel; // 标识是否需要释放高斯数据模型对象
		};
	}
}
#endif