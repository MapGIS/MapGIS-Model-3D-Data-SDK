#pragma once
#include "basdefine70.h"
#include "cgstring.h"
#include "g3dtilegeometry.h"
#include "functional"
#include "g3dtiledefine.h"
#include <array>

namespace MapGIS
{
	namespace Tile
	{
		//================================================================================
		/// 坐标系统转换器类
		/// 用于表示和处理不同坐标系统之间的变换关系
		//================================================================================
		class MAPGISG3DTILEEXPORT CoordinateSystemConverter {
		public:
			//================================================================================
			/// 3x3变换矩阵，按行优先存储
			/// 矩阵元素排列如下：
			///   [0, 1, 2]
			///   [3, 4, 5]
			///   [6, 7, 8]
			//================================================================================
			std::array<float, 9> match;

			//================================================================================
			/// 默认构造函数
			/// 初始化为单位矩阵（无变换）
			//================================================================================
			CoordinateSystemConverter()
			{
				match = { 1.0f, 0.0f, 0.0f, 0.0f, 1.0f, 0.0f, 0.0f, 0.0f, 1.0f };
			}
		};

		//================================================================================
		/// 高斯溅射数据读写类
		/// 提供对多种高斯溅射数据格式的读写支持
		//================================================================================
		class MAPGISG3DTILEEXPORT CGGaussianReadWrite
		{
		public:
			//================================================================================
			/// 默认构造函数
			//================================================================================
			CGGaussianReadWrite() = default;

			//================================================================================
			/// 虚析构函数
			/// 确保派生类能够正确析构
			//================================================================================
			virtual ~CGGaussianReadWrite() = default;

			//================================================================================
			/// 从文件读取高斯溅射数据
			/// 支持的格式包括：ply, splat, ksplat, spz, sog
			///
			/// @param [in]  filePath 文件路径
			/// @param [in,out] data  高斯数据模型对象引用，用于接收读取的数据
			///
			/// @return 操作结果
			///         - gisLONG > 0：读取成功
			///         - gisLONG <= 0：读取失败
			//================================================================================
			static gisLONG Read(CGString filePath, MapGIS::Tile::GaussianModel& data);

			//================================================================================
			/// 从文件读取高斯溅射数据（回调方式）
			/// 支持的格式包括：ply, splat, ksplat, spz, sog
			///
			/// @param [in] filePath  文件路径
			/// @param [in] callback  回调函数，用于逐个处理读取到的高斯特征点
			///                       回调参数：
			///                       - MapGIS::Tile::GaussianFeature& dot: 当前处理的高斯特征点
			///                       - bool& isStop: 设置为true可中止读取过程
			///
			/// @return 操作结果
			///         - gisLONG > 0：读取成功
			///         - gisLONG <= 0：读取失败
			//================================================================================
			static gisLONG Read(CGString filePath, std::function<void(MapGIS::Tile::GaussianFeature& dot, bool& isStop)>& callback);

			//================================================================================
			/// 将高斯溅射数据写入文件
			/// 支持的格式包括：ply, splat, spz
			///
			/// @param [in] filePath 文件路径
			/// @param [in] data     要写入的高斯数据模型对象
			///
			/// @return 操作结果
			///         - gisLONG > 0：写入成功
			///         - gisLONG <= 0：写入失败
			//================================================================================
			static gisLONG Write(CGString filePath, const MapGIS::Tile::GaussianModel& data);

		protected:
			//================================================================================
			/// 内部读取接口（纯虚函数）
			/// 由具体格式的派生类实现
			///
			/// @param [in]  filePath 文件路径
			/// @param [out] data     高斯数据模型对象引用
			///
			/// @return 操作结果
			//================================================================================
			virtual gisLONG i_Read(CGString filePath, MapGIS::Tile::GaussianModel& data) = 0;

			//================================================================================
			/// 内部回调读取接口（纯虚函数）
			/// 由具体格式的派生类实现
			///
			/// @param [in] filePath  文件路径
			/// @param [in] callback  回调函数
			///
			/// @return 操作结果
			//================================================================================
			virtual gisLONG i_Read(CGString filePath, std::function<void(MapGIS::Tile::GaussianFeature& dot, bool& isStop)>& callback) = 0;

			//================================================================================
			/// 内部写入接口（纯虚函数）
			/// 由具体格式的派生类实现
			///
			/// @param [in] filePath 文件路径
			/// @param [in] data     高斯数据模型对象引用
			///
			/// @return 操作结果
			//================================================================================
			virtual gisLONG i_Write(CGString filePath, const MapGIS::Tile::GaussianModel& data) = 0;
		};

		//================================================================================
		/// 高斯数据变换类
		/// 提供坐标系统变换相关的数学计算功能，用于处理高斯溅射数据在不同坐标系下的转换
		//================================================================================
		class MAPGISG3DTILEEXPORT CGGaussianDataTrans
		{
		public:
			//================================================================================
			/// 默认构造函数
			//================================================================================
			CGGaussianDataTrans() = default;

			//================================================================================
			/// 析构函数
			//================================================================================
			~CGGaussianDataTrans() = default;

			//================================================================================
			/// 获取坐标系统之间的转换矩阵
			///
			/// @param [in] from 源坐标系统枚举值
			/// @param [in] to   目标坐标系统枚举值
			///
			/// @return 坐标系统转换器对象，包含相应的变换矩阵
			//================================================================================
			static CoordinateSystemConverter GetCoordinateSystemConverter(CoordinateSystem from, CoordinateSystem to);

			//================================================================================
			/// 变换点坐标位置
			///
			/// @param [in] orPoints 源坐标位置 (x, y, z)
			/// @param [in] matrix   3x3变换矩阵
			///
			/// @return 变换后的坐标位置 (x, y, z)
			//================================================================================
			static std::array<float, 3> TransPoints(std::array<float, 3> orPoints, std::array<float, 9> matrix);

			//================================================================================
			/// 变换旋转四元数
			///
			/// @param [in] orRotations 源旋转四元数 (x, y, z, w)
			/// @param [in] matrix      3x3变换矩阵
			///
			/// @return 变换后的旋转四元数 (x, y, z, w)
			//================================================================================
			static std::array<float, 4> TransRotations(std::array<float, 4> orRotations, std::array<float, 9> matrix);

			//================================================================================
			/// 变换空间尺度大小
			///
			/// @param [in] orScale 源空间尺度大小 (x, y, z)
			/// @param [in] matrix  3x3变换矩阵
			///
			/// @return 变换后的空间尺度大小 (x, y, z)
			//================================================================================
			static std::array<float, 3> TransScale(std::array<float, 3> orScale, std::array<float, 9> matrix);

			//================================================================================
			/// 变换高阶球谐参数
			///
			/// @param [in] sh     源球谐参数向量
			/// @param [in] matrix 3x3变换矩阵
			///
			/// @return 变换后的球谐参数向量
			//================================================================================
			static std::vector<float> TransSh(std::vector<float>& sh, std::array<float, 9> matrix);

		private:
			//================================================================================
			/// 四元数乘法运算
			///
			/// @param [in] a 第一个四元数
			/// @param [in] b 第二个四元数
			///
			/// @return 两个四元数的乘积
			//================================================================================
			static std::array<float, 4> quatMultiply(const std::array<float, 4>& a, const std::array<float, 4>& b);

			//================================================================================
			/// 四元数单位化
			///
			/// @param [in] q 输入四元数
			///
			/// @return 单位化后的四元数
			//================================================================================
			static std::array<float, 4> normalize(std::array<float, 4> q);

			//================================================================================
			/// 将旋转矩阵转换为ZYX欧拉角
			///
			/// @param [in] R 3x3旋转矩阵
			///
			/// @return 欧拉角 (alpha, beta, gamma)
			//================================================================================
			static std::array<double, 3> rotation_to_euler_zyz(const std::array<float, 9>& R);

			//================================================================================
			/// 构造l=1阶实值Wigner D-矩阵
			///
			/// @param [in] alpha 第一个欧拉角
			/// @param [in] beta  第二个欧拉角
			/// @param [in] gamma 第三个欧拉角
			///
			/// @return 3x3的Wigner D-矩阵
			//================================================================================
			static std::array<std::array<double, 3>, 3> wigner_d_matrix_l1(double alpha, double beta, double gamma);

			//================================================================================
			/// 使用Wigner D-矩阵旋转一阶球谐系数
			///
			/// @param [in] coeffs 源一阶球谐系数
			/// @param [in] R      3x3旋转矩阵
			///
			/// @return 旋转后的一阶球谐系数
			//================================================================================
			static std::array<float, 3> rotate_sh1(const std::array<float, 3>& coeffs, const std::array<float, 9>& R);

			//================================================================================
			/// 使用Wigner D-矩阵旋转二阶球谐系数
			///
			/// @param [in] coeffs 源二阶球谐系数
			/// @param [in] R      3x3旋转矩阵
			///
			/// @return 旋转后的二阶球谐系数
			//================================================================================
			static std::array<float, 5> rotate_sh2(const std::array<float, 5>& coeffs, const std::array<float, 9>& R);

			//================================================================================
			/// 构造l=3阶实值Wigner D-矩阵 (7x7)
			///
			/// @param [in] alpha 第一个欧拉角
			/// @param [in] beta  第二个欧拉角
			/// @param [in] gamma 第三个欧拉角
			///
			/// @return 7x7的Wigner D-矩阵
			//================================================================================
			static std::array<std::array<double, 7>, 7> wigner_d_matrix_l3(double alpha, double beta, double gamma);

			//================================================================================
			/// 三阶球谐系数旋转（被动变换）
			///
			/// @param [in] coeffs 源三阶球谐系数
			/// @param [in] R      3x3旋转矩阵
			///
			/// @return 旋转后的三阶球谐系数
			//================================================================================
			static std::array<float, 7> rotate_sh3(const std::array<float, 7>& coeffs, const std::array<float, 9>& R);
		};
	}
}