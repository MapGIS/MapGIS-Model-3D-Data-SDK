#pragma once
#ifndef _G3D_TILE_STORAGE_H_
#define _G3D_TILE_STORAGE_H_

#include "g3dtiledefine.h"
#include "gbytearray.h"

namespace MapGIS
{
	namespace Tile
	{
		//================================================================================
		/// 缓存存储类型枚举
		/// 定义了支持的不同存储后端类型
		//================================================================================
		enum class StorageType :int
		{
			NoneType = 0,          // 无存储类型
			MongoType = 2,         // MongoDB数据库存储
			LocalFileType = 3,    // 本地文件系统存储
			PostgresqlType = 8     // PostgreSQL数据库存储
		};

		//================================================================================
		/// 三维瓦片缓存存储抽象基类
		/// 提供统一的接口用于不同存储后端的数据读写操作
		//================================================================================
		class MAPGISG3DTILEEXPORT G3DCacheStorage
		{
		public:
			// 虚析构函数，确保派生类能正确析构
			virtual ~G3DCacheStorage() {};

			//================================================================================
			/// 创建存储实例（单参数版本）
			///
			/// @param [in] rootUrl 根路径地址
			///                 - 对于本地文件存储：文件夹路径
			///                 - 对于MongoDB存储：数据库连接URL
			///
			/// @return G3DCacheStorage对象指针，失败返回nullptr
			//================================================================================
			static G3DCacheStorage* CreateInstance(CGString rootUrl);

			//================================================================================
			/// 创建存储实例（双参数版本）
			/// 用于创建具有相对路径前缀的存储对象
			///
			/// @param [in] rootUrl 根路径地址
			///                 - 对于本地文件存储：文件夹路径
			///                 - 对于MongoDB存储：数据库连接URL
			/// @param [in] rootRelative 相对路根路径
			///                 - 后续所有相对路径操作都基于根路径加上该路径之后的相对路径
			///
			/// @return G3DCacheStorage对象指针，失败返回nullptr
			//================================================================================
			static G3DCacheStorage* CreateInstance(CGString rootUrl, CGString rootRelative);

			//================================================================================
			/// 打开存储连接
			///
			/// @param [in] isCreateIfNotExist 当存储不存在时是否自动创建
			///                 - true: 不存在则创建
			///                 - false: 不存在则不创建（默认）
			///
			/// @return 操作结果
			///         - 大于0：成功
			///         - 小于等于0：失败
			//================================================================================
			virtual gisLONG Open(bool isCreateIfNotExist = false) = 0;

			//================================================================================
			/// 检查存储是否有效可用
			///
			/// @return 存储状态
			///         - true: 存储有效
			///         - false: 存储无效
			//================================================================================
			virtual bool IsValid() = 0;

			//================================================================================
			/// 关闭存储连接
			///
			/// @return 操作结果
			///         - 大于0：成功
			///         - 小于等于0：失败
			//================================================================================
			virtual gisLONG Close() = 0;

			//================================================================================
			/// 获取指定路径的数据内容
			///
			/// @param [in]  relative 相对路径
			///                  - 相对于根路径的文件或数据项路径
			/// @param [out] buffer 用于接收数据内容的字节数组
			///
			/// @return 操作结果
			///         - 大于0：成功，返回数据大小
			///         - 小于等于0：失败
			//================================================================================
			virtual gisLONG GetContent(CGString relative, CGByteArray &buffer) = 0;

			//================================================================================
			/// 设置指定路径的数据内容（CGByteArray版本）
			///
			/// @param [in] relative 相对路径
			///                  - 相对于根路径的文件或数据项路径
			/// @param [in] buffer 要写入的数据内容
			///
			/// @return 操作结果
			///         - 大于0：成功
			///         - 小于等于0：失败
			//================================================================================
			virtual gisLONG SetContent(CGString relative, const CGByteArray &buffer) = 0;

			//================================================================================
			/// 设置指定路径的数据内容（原始指针版本）
			///
			/// @param [in] relative 相对路径
			///                  - 相对于根路径的文件或数据项路径
			/// @param [in] buffer 要写入的数据内容指针
			/// @param [in] len    数据长度（字节数）
			///
			/// @return 操作结果
			///         - 大于0：成功
			///         - 小于等于0：失败
			//================================================================================
			virtual gisLONG SetContent(CGString relative, const char *buffer, gisLONG len) = 0;

			//================================================================================
			/// 判断指定路径的数据是否存在
			///
			/// @param [in] relative 相对路径
			///                  - 相对于根路径的文件或数据项路径
			///
			/// @return 存在状态
			///         - true: 数据存在
			///         - false: 数据不存在
			//================================================================================
			virtual bool IsExistContent(CGString relative) = 0;

			//================================================================================
			/// 删除指定路径的数据
			///
			/// @param [in] relative 相对路径
			///                  - 相对于根路径的文件或数据项路径
			///
			/// @return 操作结果
			///         - 大于0：成功
			///         - 小于等于0：失败
			//================================================================================
			virtual gisLONG DeleteContent(CGString relative) = 0;

			//================================================================================
			/// 获取存储类型
			///
			/// @return 当前存储对象的类型枚举值
			//================================================================================
			virtual StorageType GetStorageType() = 0;

			//================================================================================
			/// 获取根节点URL
			///
			/// @return 根路径URL字符串
			///         - 对于文件系统：文件夹路径
			///         - 对于数据库：连接URL
			//================================================================================
			CGString GetRootUrl() { return m_url; }

			//================================================================================
			/// 获取根相对路径
			///
			/// @return 根相对路径前缀字符串
			//================================================================================
			CGString GetRootRelative() { return m_rootRelative; }

		protected:
			//================================================================================
			/// 构造函数（单参数版本）
			///
			/// @param [in] url 根路径URL
			//================================================================================
			G3DCacheStorage(CGString url) : m_url(url), m_rootRelative("") {
			};

			//================================================================================
			/// 构造函数（双参数版本）
			///
			/// @param [in] url 根路径URL
			/// @param [in] rootRelative 相对根路径
			//================================================================================
			G3DCacheStorage(CGString url, CGString rootRelative) : m_url(url), m_rootRelative(rootRelative) {
			};

		protected:
			CGString m_url;           // 根路径URL
			CGString m_rootRelative;  // 相对根路径
		};
	}
}
#endif